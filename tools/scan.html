<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>üì∑ Scanner Mode ‚Ä¢ NiceDay PDF Jar</title>

<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.2/Sortable.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

<style>
  :root{
    --ink:#f8fafc; --muted:#cbd5e1;
    --chip:#111827cc; --chip-ink:#e5e7eb;
    --brand:#2563eb; --brand-2:#60a5fa;
    --ok:#16a34a; --danger:#ef4444;
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;background:#000;color:var(--ink);
    font:15px/1.45 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial}

  .wrap{position:fixed; inset:0; display:flex; flex-direction:column}
  .stage{position:relative; flex:1; min-height:40vh; background:#000}
  video#video{position:absolute; inset:0; width:100%; height:100%; object-fit:cover; transform:translateZ(0)}

  /* All overlay UI sits above the video */
  .overlay{position:absolute; inset:0; pointer-events:none}

  /* Top chips */
  .topbar{
    position:absolute; top:calc(env(safe-area-inset-top, 0) + 10px); left:10px; right:10px;
    display:flex; justify-content:space-between; gap:.5rem; pointer-events:none; z-index:20;
  }
  .chips{display:flex; gap:.5rem; flex-wrap:wrap}
  .chip{
    pointer-events:auto; backdrop-filter:blur(6px);
    background:var(--chip); color:var(--chip-ink);
    border:1px solid #00000040; border-radius:999px; padding:.45rem .7rem;
    font-weight:700; font-size:.9rem; display:inline-flex; align-items:center; gap:.4rem;
  }
  .chip select,.chip button{appearance:none;border:0;background:transparent;font:inherit;color:inherit;cursor:pointer}
  .chip select{padding-right:18px}
  .dot{width:8px;height:8px;border-radius:50%}
  .dot.on{background:var(--ok)} .dot.off{background:var(--danger)}

  /* Round capture button ‚Äî now clickable and higher so it doesn't overlap export bar */
  #snapBtn{
    position:absolute; left:50%; transform:translateX(-50%);
    bottom:calc(env(safe-area-inset-bottom, 0) + 140px);
    width:78px; height:78px; border-radius:50%; border:4px solid #fff; cursor:pointer; z-index:30;
    background:radial-gradient(circle at 30% 30%, #8ab4ff 0%, #4a78ff 38%, #2563eb 68%, #1745a3 100%);
    box-shadow:0 10px 28px rgba(0,0,0,.45);
    pointer-events:auto;
  }
  #snapBtn:active{transform:translateX(-50%) scale(.96)}
  #snapBtn::after{content:""; position:absolute; inset:10px; border-radius:50%; border:2px solid #ffffffaa}

  /* Subtle thirds grid guide */
  .grid{
    position:absolute; inset:0; z-index:10; pointer-events:none;
    background:
      linear-gradient(#ffffff0a 1px, transparent 1px) 0 0/100% calc(100%/3),
      linear-gradient(90deg, #ffffff0a 1px, transparent 1px) 0 0/calc(100%/3) 100%;
  }

  /* Bottom controls */
  .controls{
    position:absolute; left:0; right:0;
    bottom:calc(env(safe-area-inset-bottom, 0) + 12px);
    display:flex; flex-direction:column; gap:.6rem; padding:0 10px; z-index:20; pointer-events:none;
  }
  .filters{
    display:flex; gap:.5rem; overflow-x:auto; padding:0 2px; -webkit-overflow-scrolling:touch;
    pointer-events:auto;
  }
  .filter-btn{
    flex:0 0 auto; border:1px solid #334155; background:#0b1220; color:#e2e8f0;
    padding:.5rem .8rem; border-radius:999px; font-size:.9rem; cursor:pointer;
  }
  .filter-btn.active{border-color:var(--brand); background:#0b1a3a}

  .actions{display:flex; justify-content:center; align-items:center; gap:.7rem; pointer-events:auto}
  .btn{
    border:0; border-radius:14px; padding:.85rem 1.2rem; cursor:pointer; font-weight:800; letter-spacing:.2px;
    color:#fff; background:linear-gradient(90deg, var(--brand), var(--brand-2));
    box-shadow:0 10px 26px rgba(37,99,235,.28);
  }
  .btn.secondary{background:#ffffffe6; color:#111827; box-shadow:0 8px 18px rgba(0,0,0,.18)}
  .btn.pill{border-radius:999px}

  /* Thumbnails tray */
  .tray{
    background:linear-gradient(180deg, rgba(0,0,0,0), rgba(0,0,0,.4));
    padding:10px 10px calc(env(safe-area-inset-bottom, 10px) + 10px);
  }
  #thumbs{
    display:flex; gap:10px; overflow:auto; padding:6px 4px 2px; -webkit-overflow-scrolling:touch;
    scroll-snap-type:x mandatory; touch-action:pan-x;
  }
  .thumb{
    position:relative; border-radius:10px; overflow:hidden; background:#0b0b0b;
    border:1px solid rgba(255,255,255,.15); min-width:110px; scroll-snap-align:center;
  }
  .thumb img{display:block; width:110px; height:150px; object-fit:cover}
  .thumb .idx{position:absolute; top:4px; left:4px; font-size:.75rem; background:#000000a8; color:#fff; padding:2px 6px; border-radius:999px}
  .thumb .del{position:absolute; top:4px; right:4px; border:0; border-radius:999px; background:#000000b0; color:#fff; width:24px; height:24px; cursor:pointer}
  .thumb.ghost{opacity:.5}
  .hint{margin:4px 12px 6px; color:var(--muted); font-size:.9rem}

  @media (max-width:480px){
    .btn.secondary{display:none}
  }
</style>
</head>
<body>
<div class="wrap">

  <div class="stage">
    <video id="video" autoplay playsinline></video>

    <div class="overlay">
      <!-- top chips -->
      <div class="topbar">
        <div class="chips">
          <div class="chip"><span class="dot on" id="camDot"></span><span id="camState">camera: on</span></div>
          <div class="chip"><span id="pageCount">0</span> page(s)</div>
          <div class="chip">
            <label for="detectSel" style="opacity:.9">auto-detect</label>
            <select id="detectSel">
              <option value="auto" selected>auto-detect ‚úì</option>
              <option value="manual">manual</option>
            </select>
          </div>
        </div>
        <div class="chips">
          <div class="chip"><button id="torchBtn" title="Toggle torch">üî¶ Torch</button></div>
          <div class="chip"><button id="swapBtn" title="Swap camera">üîÅ Swap</button></div>
        </div>
      </div>

      <!-- clickable capture button -->
      <button id="snapBtn" aria-label="Capture photo"></button>

      <!-- thirds grid -->
      <div class="grid" aria-hidden="true"></div>

      <!-- bottom controls -->
      <div class="controls">
        <div class="filters" id="filters">
          <button class="filter-btn active" data-filter="auto">Auto</button>
          <button class="filter-btn" data-filter="color">Color</button>
          <button class="filter-btn" data-filter="gray">Grayscale</button>
          <button class="filter-btn" data-filter="bw">B/W (scan)</button>
          <button class="filter-btn" data-filter="enhance">Enhance</button>
        </div>
        <div class="actions">
          <button id="exportBtn" class="btn pill">üìÑ Export PDF</button>
          <button id="clearBtn" class="btn secondary pill">Clear</button>
        </div>
      </div>
    </div>
  </div>

  <!-- thumbnails tray -->
  <div class="tray">
    <p class="hint" id="hint" style="display:none">Drag to reorder ‚Ä¢ tap √ó to delete</p>
    <div id="thumbs" aria-live="polite"></div>
  </div>
</div>

<script src="../assets/celebrate.js"></script>

<script>
  const video = document.getElementById('video');
  const camDot = document.getElementById('camDot');
  const camState = document.getElementById('camState');
  const pageCount = document.getElementById('pageCount');
  const thumbs = document.getElementById('thumbs');
  const hint = document.getElementById('hint');

  const snapBtn = document.getElementById('snapBtn');
  const exportBtn = document.getElementById('exportBtn');
  const clearBtn = document.getElementById('clearBtn');
  const swapBtn = document.getElementById('swapBtn');
  const torchBtn = document.getElementById('torchBtn');
  const detectSel = document.getElementById('detectSel');
  const filtersWrap = document.getElementById('filters');

  let stream=null, track=null, imageCapture=null;
  let usingBack=true, torchOn=false;
  let filterMode='auto';
  const pages=[];

  function updateCount(){ pageCount.textContent=String(pages.length); hint.style.display = pages.length?'block':'none'; }

  async function startCamera(){
    stopCamera();
    try{
      stream = await navigator.mediaDevices.getUserMedia({
        video:{ facingMode: usingBack ? {ideal:'environment'} : 'user', width:{ideal:1920}, height:{ideal:1080} },
        audio:false
      });
      video.srcObject=stream;
      track = stream.getVideoTracks()[0]||null;
      try{ imageCapture = track ? new ImageCapture(track):null; }catch{ imageCapture=null; }
      camDot.classList.remove('off'); camDot.classList.add('on');
      camState.textContent='camera: on';
    }catch(e){
      console.error(e);
      camDot.classList.remove('on'); camDot.classList.add('off');
      camState.textContent='camera: blocked';
      alert('Could not access camera. Please allow camera permissions.');
    }
  }
  function stopCamera(){ if(stream) stream.getTracks().forEach(t=>t.stop()); stream=null; track=null; imageCapture=null; }

  async function toggleTorch(){
    if(!track) return;
    try{
      const caps = track.getCapabilities?.();
      if(caps && 'torch' in caps){
        torchOn=!torchOn;
        await track.applyConstraints({ advanced:[{ torch: torchOn }] });
        torchBtn.textContent = torchOn ? 'üî¶ Torch on' : 'üî¶ Torch';
      }else{ alert('Torch not supported on this device/browser.'); }
    }catch(err){ console.warn('Torch error:', err); }
  }

  swapBtn.addEventListener('click', async()=>{ usingBack=!usingBack; await startCamera(); });
  torchBtn.addEventListener('click', toggleTorch);

  function applyFilter(ctx,w,h,mode){
    const img=ctx.getImageData(0,0,w,h), d=img.data;
    const toGray=(mode==='gray'||mode==='bw'||mode==='enhance'||mode==='auto');
    if(toGray){
      for(let i=0;i<d.length;i+=4){
        const y = 0.2126*d[i] + 0.7152*d[i+1] + 0.0722*d[i+2];
        d[i]=d[i+1]=d[i+2]=y;
      }
    }
    if(mode==='bw'||mode==='auto'){
      let sum=0,cnt=0; for(let i=0;i<d.length;i+=16){ sum+=d[i]; cnt++; }
      const T=(sum/cnt)*0.95;
      for(let i=0;i<d.length;i+=4){ const v=d[i]>T?255:0; d[i]=d[i+1]=d[i+2]=v; }
    }
    if(mode==='enhance'||mode==='auto'){
      const c=1.18,o=12;
      for(let i=0;i<d.length;i+=4){
        d[i]=Math.min(255,Math.max(0,(d[i]-o)*c+o));
        d[i+1]=Math.min(255,Math.max(0,(d[i+1]-o)*c+o));
        d[i+2]=Math.min(255,Math.max(0,(d[i+2]-o)*c+o));
      }
    }
    ctx.putImageData(img,0,0);
  }

  async function captureFrame(){
    if(!video.videoWidth) return;
    const vw=video.videoWidth, vh=video.videoHeight;
    const c=document.createElement('canvas'); c.width=vw; c.height=vh;
    const g=c.getContext('2d');
    g.drawImage(video,0,0,vw,vh);
    applyFilter(g,vw,vh,filterMode);
    const dataURL=c.toDataURL('image/jpeg',0.92);
    pages.push({dataURL,w:vw,h:vh});
    addThumb(pages.length-1);
    updateCount();
  }

  function addThumb(idx){
    const page=pages[idx];
    const li=document.createElement('div'); li.className='thumb';
    const im=document.createElement('img'); im.src=page.dataURL; im.alt='Scanned page';
    const badge=document.createElement('span'); badge.className='idx'; badge.textContent=String(idx+1);
    const del=document.createElement('button'); del.className='del'; del.textContent='√ó';
    del.addEventListener('click', ()=>{
      const pos=[...thumbs.children].indexOf(li);
      pages.splice(pos,1); li.remove(); redrawIndexes(); updateCount();
    });
    li.append(im,badge,del); thumbs.appendChild(li);
  }
  function redrawIndexes(){ [...thumbs.children].forEach((el,i)=>{ const b=el.querySelector('.idx'); if(b) b.textContent=String(i+1); }); }

  new Sortable(thumbs,{
    animation:150, ghostClass:'ghost', forceFallback:true, fallbackOnBody:true,
    onEnd(){
      const ordered=[...thumbs.querySelectorAll('.thumb img')].map(img=>pages.find(p=>p.dataURL===img.src)).filter(Boolean);
      pages.length=0; pages.push(...ordered); redrawIndexes();
    }
  });

  async function exportPDF(){
    if(!pages.length){ alert('Capture at least one page.'); return; }
    const { jsPDF } = window.jspdf;
    const pdf=new jsPDF({unit:'pt',format:'a4',orientation:'portrait'});
    for(let i=0;i<pages.length;i++){
      const p=pages[i]; const landscape=p.w>=p.h;
      if(i>0) pdf.addPage(landscape?'l':'p');
      if(i===0 && landscape){ pdf.deletePage(1); pdf.addPage('l'); pdf.setPage(1); }
      const W=pdf.internal.pageSize.getWidth(), H=pdf.internal.pageSize.getHeight();
      const r=p.w/p.h; let w=W-72, h=w/r; if(h>H-72){ h=H-72; w=h*r; }
      const x=(W-w)/2, y=(H-h)/2;
      pdf.addImage(p.dataURL,'JPEG',x,y,w,h,undefined,'FAST');
    }
    const blob=pdf.output('blob'); const url=URL.createObjectURL(blob);
    const a=document.createElement('a'); a.href=url; a.download='scan.pdf'; a.click();
    window.showCelebration?.(url);
  }

  snapBtn.addEventListener('click', captureFrame);
  exportBtn.addEventListener('click', exportPDF);
  clearBtn.addEventListener('click', ()=>{ pages.length=0; thumbs.innerHTML=''; updateCount(); });

  filtersWrap.addEventListener('click',(e)=>{
    const b=e.target.closest('.filter-btn'); if(!b) return;
    document.querySelectorAll('.filter-btn').forEach(x=>x.classList.remove('active'));
    b.classList.add('active'); filterMode=b.dataset.filter||'auto';
  });

  detectSel.addEventListener('change', ()=>{/* placeholder for future auto-detect */});

  startCamera();
  document.addEventListener('visibilitychange', ()=>{ if(document.hidden) stopCamera(); else startCamera(); });
  window.addEventListener('beforeunload', stopCamera);
</script>
</body>
</html>
