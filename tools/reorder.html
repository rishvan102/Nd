<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>üìë Reorder Pages ‚Ä¢ NiceDay PDF Jar</title>

  <!-- Minimal, self-contained styles -->
  <style>
    :root[data-theme="light"]{
      --bg:#f7f8fb; --card:#fff; --ink:#0f172a; --muted:#667085;
      --border:#e6eaf0; --brand:#2563eb; --brand2:#60a5fa;
      --ring:0 0 0 4px rgba(37,99,235,.15);
    }
    :root[data-theme="dark"]{
      --bg:#0c1020; --card:#0f1428; --ink:#e7e9f2; --muted:#a1a8c5;
      --border:#1d274a; --brand:#7aa2ff; --brand2:#a9c2ff;
      --ring:0 0 0 4px rgba(122,162,255,.18);
    }

    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--ink);font:15px/1.5 "Inter",system-ui,Segoe UI,Roboto,Arial}
    .wrap{max-width:980px;margin:22px auto 40px;padding:0 16px}

    /* Header */
    .hero{display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap;margin-bottom:12px}
    .hero-left{display:flex;align-items:center;gap:12px}
    .logo{width:42px;height:42px;border-radius:12px;display:grid;place-items:center;
      background:linear-gradient(135deg,var(--brand),var(--brand2));color:#fff;font-weight:800}
    .title{display:flex;flex-direction:column}
    .title h1{margin:0;font-size:20px}
    .subtitle{margin:2px 0 0;color:var(--muted);font-size:13px}
    .themeBtn{border:1px solid var(--border);background:var(--card);color:var(--ink);padding:.45rem .8rem;border-radius:999px;cursor:pointer}

    /* Card */
    .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:14px;box-shadow:0 10px 26px rgba(2,6,23,.06)}

    /* Drop zone */
    .drop{display:flex;align-items:center;gap:10px;padding:14px;border:2px dashed var(--border);border-radius:14px;background:color-mix(in oklab,var(--card),#000 2%);cursor:pointer}
    .fileBadge{margin-left:auto;font-size:12px;padding:6px 10px;border:1px solid var(--border);border-radius:10px;color:var(--muted);max-width:55%;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
    #file{display:none}

    /* Controls */
    .row{display:flex;flex-wrap:wrap;gap:.5rem;margin-top:10px}
    .btn{border:1px solid var(--border);background:var(--card);color:var(--ink);padding:.55rem .8rem;border-radius:10px;cursor:pointer}
    .btn.primary{background:linear-gradient(90deg,var(--brand),var(--brand2));border-color:transparent;color:#fff;font-weight:800}
    .status{margin-top:8px;color:var(--muted);font-size:13px}

    /* Thumbs grid */
    #thumbs{display:grid;grid-template-columns:repeat(auto-fill,minmax(120px,1fr));gap:.75rem;margin-top:12px}
    .thumb{position:relative;border:1px solid var(--border);border-radius:10px;background:var(--card);overflow:hidden;touch-action:none}
    .thumb.dragging{opacity:.6}
    .thumb .num{position:absolute;top:6px;left:6px;background:rgba(0,0,0,.7);color:#fff;border-radius:6px;padding:2px 6px;font-size:11px}
    .thumb .x{position:absolute;top:6px;right:6px;width:22px;height:22px;border-radius:50%;
      background:#ef4444;color:#fff;display:grid;place-items:center;font-weight:800;cursor:pointer;border:1px solid rgba(0,0,0,.15)}
    .thumb canvas{width:100%;height:auto;display:block}
    .thumb.excluded{opacity:.45}
    .badge{display:inline-flex;gap:6px;align-items:center;border:1px solid var(--border);border-radius:999px;padding:6px 10px;font-size:12px;color:var(--muted)}

    /* Accessibility focus */
    .thumb:focus-visible{outline:2px solid var(--brand);outline-offset:2px;border-radius:10px}
  </style>
</head>
<body>
  <main class="wrap">
    <!-- Header -->
    <div class="hero">
      <div class="hero-left">
        <div class="logo">ND</div>
        <div class="title">
          <h1>üìë Reorder Pages</h1>
          <p class="subtitle">Drag thumbnails to reorder. Tap ‚ùå to exclude pages. Export when ready.</p>
        </div>
      </div>
      <button id="themeBtn" class="themeBtn" type="button">üåô Dark</button>
    </div>

    <!-- Tool -->
    <section class="card">
      <!-- Drop / choose -->
      <label for="file" class="drop" id="dropZone" tabindex="0" aria-label="Drop your PDF here, or click to choose">
        <span>üìÑ Drop your PDF here, or click to choose</span>
        <div id="fileBadge" class="fileBadge" hidden></div>
      </label>
      <input id="file" type="file" accept="application/pdf" />

      <!-- Controls -->
      <div class="row">
        <span id="countBadge" class="badge" hidden></span>
        <span style="flex:1"></span>
        <button id="reset" class="btn">Reset Order</button>
        <button id="export" class="btn primary">Export Reordered PDF</button>
      </div>

      <!-- Thumbnails -->
      <div id="thumbs" aria-live="polite" aria-label="Page thumbnails"></div>

      <p id="status" class="status" aria-live="polite">Choose a PDF to begin.</p>
    </section>
  </main>

  <!-- libs -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.2/Sortable.min.js"></script>
  <script src="../assets/celebrate.js?v=1"></script>

  <script>
    /* ---------- Theme (light default) ---------- */
    const root = document.documentElement;
    const themeBtn = document.getElementById('themeBtn');
    const saved = localStorage.getItem('nd-theme');
    function setTheme(mode){ root.setAttribute('data-theme', mode); themeBtn.textContent = mode==='dark' ? '‚òÄÔ∏è Light' : 'üåô Dark'; localStorage.setItem('nd-theme', mode); }
    setTheme(saved === 'dark' ? 'dark' : 'light');
    themeBtn.onclick = () => setTheme(root.getAttribute('data-theme')==='dark' ? 'light' : 'dark');

    /* ---------- Elements ---------- */
    const fileEl   = document.getElementById('file');
    const drop     = document.getElementById('dropZone');
    const badge    = document.getElementById('fileBadge');
    const statusEl = document.getElementById('status');
    const thumbsEl = document.getElementById('thumbs');
    const resetBtn = document.getElementById('reset');
    const exportBtn= document.getElementById('export');
    const countBadge = document.getElementById('countBadge');

    let pdfDoc = null;
    let initialOrder = []; // 1-based page numbers
    let excluded = new Set(); // 1-based excluded pages

    function setBadge(name, size) {
      if (!name) { badge.hidden = true; return; }
      const kb = Math.max(1, Math.round(size/1024));
      badge.textContent = `${name} ‚Ä¢ ${kb} KB`;
      badge.hidden = false;
    }
    function setStatus(s) { statusEl.textContent = s || ''; }
    function updateCount() {
      if (!pdfDoc) { countBadge.hidden = true; return; }
      const total = pdfDoc.numPages;
      const kept  = total - excluded.size;
      countBadge.textContent = `Pages: ${kept}/${total}`;
      countBadge.hidden = false;
    }

    /* ---------- Drag & Drop to choose file ---------- */
    drop.addEventListener('keydown', e => {
      if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); fileEl.click(); }
    });
    ['dragenter','dragover'].forEach(evt => {
      drop.addEventListener(evt, e => {
        e.preventDefault(); e.stopPropagation();
        drop.style.borderColor = 'color-mix(in oklab, var(--brand) 55%, #fff)';
      });
    });
    ['dragleave','drop'].forEach(evt => {
      drop.addEventListener(evt, e => {
        e.preventDefault(); e.stopPropagation();
        drop.style.borderColor = 'var(--border)';
      });
    });
    drop.addEventListener('drop', e => {
      const f = e.dataTransfer?.files?.[0];
      if (f && f.type === 'application/pdf') {
        fileEl.files = e.dataTransfer.files;
        fileEl.dispatchEvent(new Event('change'));
      }
    });

    /* ---------- Render thumbnails ---------- */
    async function renderThumbs() {
      thumbsEl.innerHTML = '';
      excluded.clear();
      updateCount();

      if (!pdfDoc) return;
      const total = pdfDoc.numPages;
      initialOrder = [...Array(total)].map((_,i)=>i+1);

      for (let i=1; i<=total; i++) {
        const page = await pdfDoc.getPage(i);
        const vp = page.getViewport({ scale: 0.35 });
        const canvas = document.createElement('canvas');
        canvas.width = vp.width; canvas.height = vp.height;
        const ctx = canvas.getContext('2d', { willReadFrequently:true });
        await page.render({ canvasContext: ctx, viewport: vp }).promise;

        const div = document.createElement('div');
        div.className = 'thumb'; div.tabIndex = 0;
        div.dataset.page = String(i);     // 1-based page number
        div.innerHTML = `<div class="num">${i}</div><div class="x" title="Exclude / include">√ó</div>`;
        div.appendChild(canvas);

        // toggle exclude
        div.querySelector('.x').addEventListener('click', (e) => {
          e.stopPropagation();
          const p = Number(div.dataset.page);
          if (excluded.has(p)) { excluded.delete(p); div.classList.remove('excluded'); }
          else { excluded.add(p); div.classList.add('excluded'); }
          updateCount();
        });

        thumbsEl.appendChild(div);
      }

      // Make the grid sortable (mobile + desktop)
      new Sortable(thumbsEl, {
        animation: 150,
        ghostClass: 'dragging',
        forceFallback: true,   // ensures touch works well on mobile
        fallbackTolerance: 3,
        onEnd(){ /* order is implicitly saved by DOM order */ }
      });

      setStatus(`Loaded ${total} pages. Drag to reorder. Tap ‚ùå to exclude.`);
    }

    fileEl.addEventListener('change', async (e) => {
      const f = e.target.files?.[0]; if (!f) return;
      setBadge(f.name, f.size);
      setStatus('Loading PDF‚Ä¶');
      try {
        const buf = await f.arrayBuffer();
        pdfDoc = await pdfjsLib.getDocument({ data: buf }).promise;
        await renderThumbs();
      } catch (err) {
        console.error(err);
        setStatus('Failed to load PDF.');
      }
    });

    /* ---------- Reset ---------- */
    resetBtn.addEventListener('click', async () => {
      if (!pdfDoc) return setStatus('Load a PDF first.');
      // Rebuild thumbs in original order
      await renderThumbs();
      setStatus('Order reset.');
    });

    /* ---------- Export ---------- */
    exportBtn.addEventListener('click', async () => {
      if (!pdfDoc) return setStatus('Load a PDF first.');

      const f = fileEl.files?.[0];
      if (!f) return setStatus('Choose a PDF first.');

      // Determine current DOM order (array of 1-based page numbers)
      const order = [...thumbsEl.querySelectorAll('.thumb')]
                      .map(el => Number(el.dataset.page))
                      .filter(n => Number.isFinite(n));

      // Apply exclusion
      const kept = order.filter(n => !excluded.has(n));
      if (kept.length === 0) return setStatus('No pages selected to keep.');

      setStatus('Exporting‚Ä¶');
      const buf = await f.arrayBuffer();
      const src = await PDFLib.PDFDocument.load(buf);
      const out = await PDFLib.PDFDocument.create();

      for (const oneBased of kept) {
        const idx = oneBased - 1;
        if (idx < 0 || idx >= src.getPageCount()) continue;
        const [copied] = await out.copyPages(src, [idx]);
        out.addPage(copied);
      }

      const bytes = await out.save();
      const blob = new Blob([bytes], { type:'application/pdf' });
      const url = URL.createObjectURL(blob);

      const a = document.createElement('a');
      a.href = url; a.download = 'reordered.pdf'; a.click();

      setStatus(`Done. Exported ${kept.length} page(s).`);
      window.showCelebration?.(url);
      setTimeout(()=>window.hideCelebration?.(), 1400);
    });
  </script>
</body>
</html>
